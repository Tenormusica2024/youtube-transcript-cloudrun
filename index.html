<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ğŸ¬ YouTube Transcript Extractor - Bookmarklet</title>
  <style>
    :root {
      --primary: #ff0000;
      --primary-dark: #cc0000;
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e9ecef;
      --text: #212529;
      --text-muted: #6c757d;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .hero {
      text-align: center;
      margin-bottom: 48px;
    }
    
    .hero h1 {
      font-size: 2.5rem;
      margin: 0 0 16px 0;
      color: var(--primary);
    }
    
    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      margin: 0;
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    
    .bookmark-area {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 40px;
      border-radius: 20px;
      margin: 32px 0;
    }
    
    .bookmark-area h2 {
      margin: 0 0 20px 0;
      font-size: 1.8rem;
    }
    
    .bookmark-link {
      display: inline-block;
      padding: 16px 32px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50px;
      color: white;
      text-decoration: none;
      font-size: 1.2rem;
      font-weight: bold;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .bookmark-link:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .config-section {
      background: #f8f9ff;
      border-left: 4px solid var(--primary);
      padding: 20px;
      border-radius: 0 12px 12px 0;
      margin: 24px 0;
    }
    
    .input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .input-group label {
      font-weight: 600;
      min-width: 120px;
    }
    
    .input-group input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      min-width: 300px;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,0,0,0.1);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .steps {
      counter-reset: step;
    }
    
    .step {
      counter-increment: step;
      margin: 24px 0;
      padding: 20px;
      border-left: 4px solid #28a745;
      background: #f8fff9;
      border-radius: 0 8px 8px 0;
    }
    
    .step::before {
      content: counter(step);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #28a745;
      color: white;
      border-radius: 50%;
      font-weight: bold;
      margin-right: 16px;
      flex-shrink: 0;
    }
    
    .step h3 {
      display: inline;
      margin: 0;
      vertical-align: middle;
    }
    
    pre, code {
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.9em;
    }
    
    pre {
      padding: 16px;
      overflow-x: auto;
      border: 1px solid var(--border);
    }
    
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
    }
    
    .alert-info {
      background: #e7f3ff;
      border-left: 4px solid #0066cc;
      color: #004499;
    }
    
    .alert-warning {
      background: #fff8e1;
      border-left: 4px solid #ffa726;
      color: #e65100;
    }
    
    .demo-gif {
      text-align: center;
      margin: 32px 0;
    }
    
    .demo-gif img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    details {
      margin: 20px 0;
    }
    
    summary {
      cursor: pointer;
      padding: 12px;
      background: #f1f3f4;
      border-radius: 8px;
      font-weight: 600;
    }
    
    details[open] summary {
      border-radius: 8px 8px 0 0;
      border-bottom: 1px solid var(--border);
    }
    
    details pre {
      margin: 0;
      border-radius: 0 0 8px 8px;
      border-top: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1>ğŸ¬ YouTube Transcript Extractor</h1>
      <p>YouTubeã®å­—å¹•ã‚’ç¬æ™‚ã«æŠ½å‡ºã—ã€AIè¦ç´„ã‚’ç”Ÿæˆã€‚ä»–ã®PCã§ã‚‚ç°¡å˜ã«ä½¿ãˆã‚‹ï¼</p>
    </div>

    <div class="card">
      <div class="bookmark-area">
        <h2>ğŸ“ ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ</h2>
        <p>ã“ã®ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã¸ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„</p>
        <a id="bookmarklet" class="bookmark-link" href="javascript:void(0)">ğŸ¬ YT Transcript</a>
        <p><small>â€» åˆå›ã®ã¿è¨­å®šãŒå¿…è¦ã§ã™ã€‚ãã®å¾Œã¯ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ä½¿ç”¨ã§ãã¾ã™ã€‚</small></p>
      </div>

      <div class="config-section">
        <h3>âš™ï¸ APIè¨­å®š</h3>
        <p>ã‚ãªãŸã®Cloud Run APIã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š</p>
        <div class="input-group">
          <label for="apiUrl">API URL:</label>
          <input 
            type="url" 
            id="apiUrl" 
            placeholder="https://your-service-xxxxx.a.run.app"
            value=""
          >
          <button class="btn" id="updateBookmarklet">æ›´æ–°</button>
        </div>
        
        <div class="alert alert-info">
          <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹URLã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸš€ ä½¿ã„æ–¹ï¼ˆ3ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</h2>
      <div class="steps">
        <div class="step">
          <h3>API URLã‚’è¨­å®š</h3>
          <p>ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ãªãŸã®Cloud Run APIã®URLã‚’å…¥åŠ›ã—ã€ã€Œæ›´æ–°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
        </div>
        
        <div class="step">
          <h3>ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒ‰ãƒ©ãƒƒã‚°</h3>
          <p>é’ã„ãƒœã‚¿ãƒ³ã€ŒğŸ¬ YT Transcriptã€ã‚’ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã¸ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
        </div>
        
        <div class="step">
          <h3>YouTubeã§ä½¿ç”¨</h3>
          <p>YouTubeå‹•ç”»ãƒšãƒ¼ã‚¸ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ è‡ªå‹•çš„ã«å­—å¹•æŠ½å‡º & AIè¦ç´„ã‚’è¡¨ç¤º</p>
        </div>
      </div>

      <div class="demo-gif">
        <p><strong>ğŸ“º ãƒ‡ãƒ¢ã‚¤ãƒ¡ãƒ¼ã‚¸</strong></p>
        <div style="background: #f0f0f0; padding: 40px; border-radius: 12px; color: #666;">
          <p>YouTubeå‹•ç”»ãƒšãƒ¼ã‚¸ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯</p>
          <p>â†“</p>
          <p>å³ä¸Šã«å­—å¹•æŠ½å‡ºçµæœã¨AIè¦ç´„ãŒè¡¨ç¤º</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>âœ¨ ç‰¹å¾´</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="padding: 20px; background: #f8fff8; border-radius: 8px; border-left: 4px solid #28a745;">
          <h3 style="margin: 0 0 8px 0; color: #28a745;">ğŸ†“ å®Œå…¨ç„¡æ–™</h3>
          <p style="margin: 0; font-size: 0.9rem;">å­—å¹•æŠ½å‡ºã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å®Ÿè¡Œã€‚ã‚µãƒ¼ãƒãƒ¼ã‚³ã‚¹ãƒˆã‚’æœ€å°é™ã«æŠ‘åˆ¶ã€‚</p>
        </div>
        
        <div style="padding: 20px; background: #fff8f0; border-radius: 8px; border-left: 4px solid #ffa726;">
          <h3 style="margin: 0 0 8px 0; color: #f57c00;">ğŸŒ ã©ã“ã§ã‚‚ä½¿ãˆã‚‹</h3>
          <p style="margin: 0; font-size: 0.9rem;">ä¸€åº¦è¨­å®šã™ã‚Œã°ã€ã©ã®PCã§ã‚‚åˆ¶ç´„ãªãåˆ©ç”¨å¯èƒ½ã€‚</p>
        </div>
        
        <div style="padding: 20px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196f3;">
          <h3 style="margin: 0 0 8px 0; color: #1976d2;">âš¡ é«˜é€Ÿ</h3>
          <p style="margin: 0; font-size: 0.9rem;">ãƒ­ãƒ¼ã‚«ãƒ«IPã‹ã‚‰YouTubeã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã€‚åˆ¶é™ã‚„ãƒ—ãƒ­ã‚­ã‚·ä¸è¦ã€‚</p>
        </div>
        
        <div style="padding: 20px; background: #f8f0ff; border-radius: 8px; border-left: 4px solid #9c27b0;">
          <h3 style="margin: 0 0 8px 0; color: #7b1fa2;">ğŸ”’ ã‚»ã‚­ãƒ¥ã‚¢</h3>
          <p style="margin: 0; font-size: 0.9rem;">APIã‚­ãƒ¼ãªã©æ©Ÿå¯†æƒ…å ±ã¯å…¨ã¦ã‚µãƒ¼ãƒãƒ¼å´ã§ç®¡ç†ã€‚</p>
        </div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>ğŸ”§ æŠ€è¡“ä»•æ§˜</summary>
        <div style="margin-top: 16px;">
          <h4>ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</h4>
          <pre><code>[YouTube Page] â†’ Bookmarklet â†’ timedtext API â†’ Cloud Run API
    â†“                â†“             â†“              â†“
 ãƒ¦ãƒ¼ã‚¶ãƒ¼         CORSå›é¿      å­—å¹•æŠ½å‡º      AIè¦ç´„ãƒ»æ•´å½¢</code></pre>
          
          <h4>å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h4>
          <ul>
            <li><strong>JSON3:</strong> YouTubeæœ€æ–°å½¢å¼</li>
            <li><strong>XML:</strong> å¾“æ¥ã®timedtextå½¢å¼</li>
            <li><strong>å¤šè¨€èª:</strong> æ—¥æœ¬èªã€è‹±èªã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯</li>
          </ul>
          
          <h4>AIè¦ç´„æ©Ÿèƒ½</h4>
          <ul>
            <li>è¦ç´„æ–‡ã®ç”Ÿæˆ</li>
            <li>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º</li>
            <li>çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º</li>
          </ul>
        </div>
      </details>
      
      <details>
        <summary>ğŸ› ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆç”Ÿæˆã•ã‚ŒãŸãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚³ãƒ¼ãƒ‰ï¼‰</summary>
        <pre id="debugCode">API URLã‚’è¨­å®šã—ã¦ãã ã•ã„</pre>
      </details>
    </div>

    <div class="alert alert-warning">
      <strong>âš ï¸ åˆ¶é™äº‹é …:</strong> ä¸€éƒ¨ã®å‹•ç”»ã§ã¯å­—å¹•ãŒæä¾›ã•ã‚Œã¦ã„ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆæ‰‹å‹•å­—å¹•ãªã—ã€è‡ªå‹•å­—å¹•ã‚ªãƒ•ã€åœ°åŸŸåˆ¶é™ãªã©ï¼‰ã€‚
    </div>
  </div>

  <script>
    // Bookmarklet source generator
    function generateBookmarkletSource(apiBaseUrl) {
      if (!apiBaseUrl) return 'void(0)';
      
      const cleanUrl = apiBaseUrl.replace(/\/$/, '');
      
      return `(()=>{
        (async()=>{
          const log=(...a)=>console.log('[YT-Transcript]',...a);
          const showToast=(html)=>{
            const d=document;
            let t=d.getElementById('yttr-toast');
            if(!t){
              t=d.createElement('div');
              t.id='yttr-toast';
              t.style.cssText='position:fixed;top:20px;right:20px;z-index:999999;padding:16px 20px;border-radius:12px;background:#111;color:#fff;max-width:450px;box-shadow:0 8px 32px rgba(0,0,0,.3);font:14px/1.6 system-ui,Segoe UI,Roboto,sans-serif;backdrop-filter:blur(10px);';
              d.body.appendChild(t);
            }
            t.innerHTML=html;
            setTimeout(()=>t.style.opacity='0.9',100);
          };

          const url=new URL(location.href);
          const vid=url.searchParams.get('v')||location.pathname.split('/').pop();
          if(!vid||vid.length<8){
            showToast('âŒ å‹•ç”»IDãŒå–å¾—ã§ãã¾ã›ã‚“');
            return;
          }
          
          showToast('â³ å­—å¹•ã‚’å–å¾—ä¸­...');

          async function fetchTimedText(params){
            const u=new URL('https://www.youtube.com/api/timedtext');
            Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
            const res=await fetch(u.toString(),{credentials:'include'});
            if(!res.ok) throw new Error('timedtext HTTP '+res.status);
            return res.text();
          }

          function parseTimedText(text){
            try{
              const j=JSON.parse(text);
              if(Array.isArray(j.events)){
                let out=[];
                j.events.forEach(e=>{
                  if(e.segs){
                    out.push(e.segs.map(s=>s.utf8).join(''));
                  }
                });
                return out.join('\\n');
              }
            }catch(_){}
            
            const div=document.createElement('div');
            div.innerHTML=text;
            const nodes=div.querySelectorAll('text');
            if(nodes&&nodes.length){
              return Array.from(nodes).map(n=>n.textContent).join('\\n');
            }
            return '';
          }

          let transcript='';
          const trials=[
            {lang:'ja', fmt:'json3'},
            {lang:'ja'},
            {lang:'en', fmt:'json3'},
            {lang:'en'},
          ];
          
          for(const t of trials){
            try{
              const resp=await fetchTimedText({v:vid, lang:t.lang, fmt:t.fmt});
              const parsed=parseTimedText(resp);
              if(parsed && parsed.trim().length>0){
                transcript=parsed;
                break;
              }
            }catch(err){
              log('timedtext error', err);
            }
          }

          if(!transcript){
            showToast('âŒ å­—å¹•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br><small>ï¼ˆéå¯¾å¿œ/æœªå…¬é–‹/æ¨©é™åˆ¶é™ã®å¯èƒ½æ€§ï¼‰</small>');
            return;
          }
          
          showToast('âœ… å­—å¹•å–å¾—å®Œäº† â†’ AIè¦ç´„ä¸­...');

          const apiUrl='${cleanUrl}/api/summarize';
          try{
            const res=await fetch(apiUrl,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({videoId:vid, transcript})
            });
            
            if(!res.ok) throw new Error('API '+res.status);
            const data=await res.json();
            
            const html = '<div style="max-height:300px;overflow-y:auto;"><strong>ğŸ¤– AIè¦ç´„</strong><br>' + 
                        (data.summary||'(è¦ç´„ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸ)') + 
                        '<hr style="margin:12px 0;border:none;border-top:1px solid #333;">' +
                        '<small>ğŸ“Š ' + ((data.meta&&data.meta.tokens)||'çµ±è¨ˆæƒ…å ±ãªã—') + '</small></div>';
            showToast(html);
          }catch(e){
            log('API error', e);
            showToast('âš ï¸ è¦ç´„APIã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ<br><small>å­—å¹•ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</small>');
            try{
              await navigator.clipboard.writeText(transcript);
            }catch(_){}
          }
        })().catch(e=>{
          console.error('YT Transcript Error:', e);
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
        });
      })()`;
    }

    function minifyJS(js) {
      return js
        .replace(/\/\*[\s\S]*?\*\//g, '')
        .replace(/\/\/.*$/gm, '')
        .replace(/\n+/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .replace(/;\s+/g, ';')
        .replace(/,\s+/g, ',')
        .replace(/\{\s+/g, '{')
        .replace(/\s+\}/g, '}')
        .trim();
    }

    function updateBookmarklet() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const source = generateBookmarkletSource(apiUrl);
      const minified = minifyJS(source);
      const bookmarkletUrl = 'javascript:' + encodeURIComponent(minified);
      
      const link = document.getElementById('bookmarklet');
      link.href = bookmarkletUrl;
      
      document.getElementById('debugCode').textContent = source;
      
      if (!apiUrl) {
        link.style.opacity = '0.5';
        link.title = 'API URLã‚’è¨­å®šã—ã¦ãã ã•ã„';
      } else {
        link.style.opacity = '1';
        link.title = 'ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒãƒ¼ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãã ã•ã„';
      }
    }

    // Event listeners
    document.getElementById('updateBookmarklet').addEventListener('click', updateBookmarklet);
    document.getElementById('apiUrl').addEventListener('input', updateBookmarklet);
    document.getElementById('apiUrl').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') updateBookmarklet();
    });

    // Initial update
    updateBookmarklet();
    
    // Auto-detect if deployed on same domain
    if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      const currentOrigin = location.origin;
      document.getElementById('apiUrl').value = currentOrigin;
      updateBookmarklet();
    }
  </script>
</body>
</html>