<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>🎬 YouTube Transcript Extractor - Bookmarklet</title>
  <style>
    :root {
      --primary: #ff0000;
      --primary-dark: #cc0000;
      --bg: #f8f9fa;
      --card: #ffffff;
      --border: #e9ecef;
      --text: #212529;
      --text-muted: #6c757d;
    }
    
    * { box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .hero {
      text-align: center;
      margin-bottom: 48px;
    }
    
    .hero h1 {
      font-size: 2.5rem;
      margin: 0 0 16px 0;
      color: var(--primary);
    }
    
    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      margin: 0;
    }
    
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    
    .bookmark-area {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 40px;
      border-radius: 20px;
      margin: 32px 0;
    }
    
    .bookmark-area h2 {
      margin: 0 0 20px 0;
      font-size: 1.8rem;
    }
    
    .bookmark-link {
      display: inline-block;
      padding: 16px 32px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50px;
      color: white;
      text-decoration: none;
      font-size: 1.2rem;
      font-weight: bold;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .bookmark-link:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    
    .config-section {
      background: #f8f9ff;
      border-left: 4px solid var(--primary);
      padding: 20px;
      border-radius: 0 12px 12px 0;
      margin: 24px 0;
    }
    
    .input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .input-group label {
      font-weight: 600;
      min-width: 120px;
    }
    
    .input-group input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      min-width: 300px;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,0,0,0.1);
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .steps {
      counter-reset: step;
    }
    
    .step {
      counter-increment: step;
      margin: 24px 0;
      padding: 20px;
      border-left: 4px solid #28a745;
      background: #f8fff9;
      border-radius: 0 8px 8px 0;
    }
    
    .step::before {
      content: counter(step);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: #28a745;
      color: white;
      border-radius: 50%;
      font-weight: bold;
      margin-right: 16px;
      flex-shrink: 0;
    }
    
    .step h3 {
      display: inline;
      margin: 0;
      vertical-align: middle;
    }
    
    pre, code {
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.9em;
    }
    
    pre {
      padding: 16px;
      overflow-x: auto;
      border: 1px solid var(--border);
    }
    
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
    }
    
    .alert-info {
      background: #e7f3ff;
      border-left: 4px solid #0066cc;
      color: #004499;
    }
    
    .alert-warning {
      background: #fff8e1;
      border-left: 4px solid #ffa726;
      color: #e65100;
    }
    
    .demo-gif {
      text-align: center;
      margin: 32px 0;
    }
    
    .demo-gif img {
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    details {
      margin: 20px 0;
    }
    
    summary {
      cursor: pointer;
      padding: 12px;
      background: #f1f3f4;
      border-radius: 8px;
      font-weight: 600;
    }
    
    details[open] summary {
      border-radius: 8px 8px 0 0;
      border-bottom: 1px solid var(--border);
    }
    
    details pre {
      margin: 0;
      border-radius: 0 0 8px 8px;
      border-top: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1>🎬 YouTube Transcript Extractor</h1>
      <p>YouTubeの字幕を瞬時に抽出し、AI要約を生成。他のPCでも簡単に使える！</p>
    </div>

    <div class="card">
      <div class="bookmark-area">
        <h2>📎 ブックマークレット</h2>
        <p>このボタンをブックマークバーへドラッグ&ドロップしてください</p>
        <a id="bookmarklet" class="bookmark-link" href="javascript:void(0)">🎬 YT Transcript</a>
        <p><small>※ 初回のみ設定が必要です。その後はワンクリックで使用できます。</small></p>
      </div>

      <div class="config-section">
        <h3>⚙️ API設定</h3>
        <p>あなたのCloud Run APIのURLを設定してください：</p>
        <div class="input-group">
          <label for="apiUrl">API URL:</label>
          <input 
            type="url" 
            id="apiUrl" 
            placeholder="https://your-service-xxxxx.a.run.app"
            value=""
          >
          <button class="btn" id="updateBookmarklet">更新</button>
        </div>
        
        <div class="alert alert-info">
          <strong>💡 ヒント:</strong> Cloud Runデプロイ後に表示されるURLをここに入力してください。
        </div>
      </div>
    </div>

    <div class="card">
      <h2>🚀 使い方（3ステップ）</h2>
      <div class="steps">
        <div class="step">
          <h3>API URLを設定</h3>
          <p>上記のフォームにあなたのCloud Run APIのURLを入力し、「更新」をクリック</p>
        </div>
        
        <div class="step">
          <h3>ブックマークレットをドラッグ</h3>
          <p>青いボタン「🎬 YT Transcript」をブックマークバーへドラッグ&ドロップ</p>
        </div>
        
        <div class="step">
          <h3>YouTubeで使用</h3>
          <p>YouTube動画ページでブックマークをクリック → 自動的に字幕抽出 & AI要約を表示</p>
        </div>
      </div>

      <div class="demo-gif">
        <p><strong>📺 デモイメージ</strong></p>
        <div style="background: #f0f0f0; padding: 40px; border-radius: 12px; color: #666;">
          <p>YouTube動画ページでブックマークレットをクリック</p>
          <p>↓</p>
          <p>右上に字幕抽出結果とAI要約が表示</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>✨ 特徴</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="padding: 20px; background: #f8fff8; border-radius: 8px; border-left: 4px solid #28a745;">
          <h3 style="margin: 0 0 8px 0; color: #28a745;">🆓 完全無料</h3>
          <p style="margin: 0; font-size: 0.9rem;">字幕抽出はクライアント側で実行。サーバーコストを最小限に抑制。</p>
        </div>
        
        <div style="padding: 20px; background: #fff8f0; border-radius: 8px; border-left: 4px solid #ffa726;">
          <h3 style="margin: 0 0 8px 0; color: #f57c00;">🌐 どこでも使える</h3>
          <p style="margin: 0; font-size: 0.9rem;">一度設定すれば、どのPCでも制約なく利用可能。</p>
        </div>
        
        <div style="padding: 20px; background: #f0f8ff; border-radius: 8px; border-left: 4px solid #2196f3;">
          <h3 style="margin: 0 0 8px 0; color: #1976d2;">⚡ 高速</h3>
          <p style="margin: 0; font-size: 0.9rem;">ローカルIPからYouTubeに直接アクセス。制限やプロキシ不要。</p>
        </div>
        
        <div style="padding: 20px; background: #f8f0ff; border-radius: 8px; border-left: 4px solid #9c27b0;">
          <h3 style="margin: 0 0 8px 0; color: #7b1fa2;">🔒 セキュア</h3>
          <p style="margin: 0; font-size: 0.9rem;">APIキーなど機密情報は全てサーバー側で管理。</p>
        </div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>🔧 技術仕様</summary>
        <div style="margin-top: 16px;">
          <h4>アーキテクチャ</h4>
          <pre><code>[YouTube Page] → Bookmarklet → timedtext API → Cloud Run API
    ↓                ↓             ↓              ↓
 ユーザー         CORS回避      字幕抽出      AI要約・整形</code></pre>
          
          <h4>対応フォーマット</h4>
          <ul>
            <li><strong>JSON3:</strong> YouTube最新形式</li>
            <li><strong>XML:</strong> 従来のtimedtext形式</li>
            <li><strong>多言語:</strong> 日本語、英語の自動フォールバック</li>
          </ul>
          
          <h4>AI要約機能</h4>
          <ul>
            <li>要約文の生成</li>
            <li>キーワード抽出</li>
            <li>統計情報の表示</li>
          </ul>
        </div>
      </details>
      
      <details>
        <summary>🐛 デバッグ表示（生成されたブックマークレットコード）</summary>
        <pre id="debugCode">API URLを設定してください</pre>
      </details>
    </div>

    <div class="alert alert-warning">
      <strong>⚠️ 制限事項:</strong> 一部の動画では字幕が提供されていない場合があります（手動字幕なし、自動字幕オフ、地域制限など）。
    </div>
  </div>

  <script>
    // Bookmarklet source generator
    function generateBookmarkletSource(apiBaseUrl) {
      if (!apiBaseUrl) return 'void(0)';
      
      const cleanUrl = apiBaseUrl.replace(/\/$/, '');
      
      return `(()=>{
        (async()=>{
          const log=(...a)=>console.log('[YT-Transcript]',...a);
          const showToast=(html)=>{
            const d=document;
            let t=d.getElementById('yttr-toast');
            if(!t){
              t=d.createElement('div');
              t.id='yttr-toast';
              t.style.cssText='position:fixed;top:20px;right:20px;z-index:999999;padding:16px 20px;border-radius:12px;background:#111;color:#fff;max-width:450px;box-shadow:0 8px 32px rgba(0,0,0,.3);font:14px/1.6 system-ui,Segoe UI,Roboto,sans-serif;backdrop-filter:blur(10px);';
              d.body.appendChild(t);
            }
            t.innerHTML=html;
            setTimeout(()=>t.style.opacity='0.9',100);
          };

          const url=new URL(location.href);
          const vid=url.searchParams.get('v')||location.pathname.split('/').pop();
          if(!vid||vid.length<8){
            showToast('❌ 動画IDが取得できません');
            return;
          }
          
          showToast('⏳ 字幕を取得中...');

          async function fetchTimedText(params){
            const u=new URL('https://www.youtube.com/api/timedtext');
            Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
            const res=await fetch(u.toString(),{credentials:'include'});
            if(!res.ok) throw new Error('timedtext HTTP '+res.status);
            return res.text();
          }

          function parseTimedText(text){
            try{
              const j=JSON.parse(text);
              if(Array.isArray(j.events)){
                let out=[];
                j.events.forEach(e=>{
                  if(e.segs){
                    out.push(e.segs.map(s=>s.utf8).join(''));
                  }
                });
                return out.join('\\n');
              }
            }catch(_){}
            
            const div=document.createElement('div');
            div.innerHTML=text;
            const nodes=div.querySelectorAll('text');
            if(nodes&&nodes.length){
              return Array.from(nodes).map(n=>n.textContent).join('\\n');
            }
            return '';
          }

          let transcript='';
          const trials=[
            {lang:'ja', fmt:'json3'},
            {lang:'ja'},
            {lang:'en', fmt:'json3'},
            {lang:'en'},
          ];
          
          for(const t of trials){
            try{
              const resp=await fetchTimedText({v:vid, lang:t.lang, fmt:t.fmt});
              const parsed=parseTimedText(resp);
              if(parsed && parsed.trim().length>0){
                transcript=parsed;
                break;
              }
            }catch(err){
              log('timedtext error', err);
            }
          }

          if(!transcript){
            showToast('❌ 字幕が見つかりません<br><small>（非対応/未公開/権限制限の可能性）</small>');
            return;
          }
          
          showToast('✅ 字幕取得完了 → AI要約中...');

          const apiUrl='${cleanUrl}/api/summarize';
          try{
            const res=await fetch(apiUrl,{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({videoId:vid, transcript})
            });
            
            if(!res.ok) throw new Error('API '+res.status);
            const data=await res.json();
            
            const html = '<div style="max-height:300px;overflow-y:auto;"><strong>🤖 AI要約</strong><br>' + 
                        (data.summary||'(要約を生成できませんでした)') + 
                        '<hr style="margin:12px 0;border:none;border-top:1px solid #333;">' +
                        '<small>📊 ' + ((data.meta&&data.meta.tokens)||'統計情報なし') + '</small></div>';
            showToast(html);
          }catch(e){
            log('API error', e);
            showToast('⚠️ 要約APIに接続できませんでした<br><small>字幕をクリップボードにコピーしました</small>');
            try{
              await navigator.clipboard.writeText(transcript);
            }catch(_){}
          }
        })().catch(e=>{
          console.error('YT Transcript Error:', e);
          alert('エラーが発生しました: ' + e.message);
        });
      })()`;
    }

    function minifyJS(js) {
      return js
        .replace(/\/\*[\s\S]*?\*\//g, '')
        .replace(/\/\/.*$/gm, '')
        .replace(/\n+/g, ' ')
        .replace(/\s{2,}/g, ' ')
        .replace(/;\s+/g, ';')
        .replace(/,\s+/g, ',')
        .replace(/\{\s+/g, '{')
        .replace(/\s+\}/g, '}')
        .trim();
    }

    function updateBookmarklet() {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const source = generateBookmarkletSource(apiUrl);
      const minified = minifyJS(source);
      const bookmarkletUrl = 'javascript:' + encodeURIComponent(minified);
      
      const link = document.getElementById('bookmarklet');
      link.href = bookmarkletUrl;
      
      document.getElementById('debugCode').textContent = source;
      
      if (!apiUrl) {
        link.style.opacity = '0.5';
        link.title = 'API URLを設定してください';
      } else {
        link.style.opacity = '1';
        link.title = 'ブックマークバーにドラッグしてください';
      }
    }

    // Event listeners
    document.getElementById('updateBookmarklet').addEventListener('click', updateBookmarklet);
    document.getElementById('apiUrl').addEventListener('input', updateBookmarklet);
    document.getElementById('apiUrl').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') updateBookmarklet();
    });

    // Initial update
    updateBookmarklet();
    
    // Auto-detect if deployed on same domain
    if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
      const currentOrigin = location.origin;
      document.getElementById('apiUrl').value = currentOrigin;
      updateBookmarklet();
    }
  </script>
</body>
</html>